<!DOCTYPE html>
<html xmlns:th="http://www.thymeleaf.org">
<head>
  <meta charset="UTF-8"/>
  <title>Books</title>
  <link rel="stylesheet" th:href="@{/css/bootstrap.css}"/>
  <style>
    body { background: #f7f7f9; }
    .filter-card { border: 1px solid #e5e7eb; border-radius: 8px; background: #fff; }
    .filter-card .card-header { background: #f3f4f6; font-weight: 600; }
    .page-shell { max-width: 1100px; }
  </style>
</head>
<body class="container py-4 page-shell">

  <!-- Header + quick search (IUCAT-like) -->
  <div class="d-flex align-items-center justify-content-between mb-3">
    <h2 class="mb-0">Books</h2>
    <div th:if="${username != null}" class="text-muted">Welcome, <span th:text="${username}">user</span>!</div>
  </div>

  <form th:action="@{/}" method="get" class="mb-3">
    <div class="row g-2">
      <div class="col-auto">
        <select class="form-select">
          <option selected>All Fields</option>
        </select>
      </div>
      <div class="col">
        <input class="form-control" type="text" name="q" th:value="${q}" placeholder="Search the library catalog">
      </div>
      <div class="col-auto">
        <button class="btn btn-dark" type="submit">Search</button>
      </div>
      <div class="col-auto">
        <a class="btn btn-outline-secondary" th:href="@{/}">Clear</a>
      </div>
    </div>
  </form>

  <div class="row">
    <!-- LEFT: Filters -->
    <aside class="col-12 col-md-3 mb-3 mb-md-0">
      <div class="filter-card card">
        <div class="card-header">Refine your search</div>
        <div class="card-body">
          <form th:action="@{/}" method="get" class="vstack gap-3">
            <!-- keep the text query when applying filters -->
            <input type="hidden" name="q" th:value="${q}"/>

            <div class="form-check">
              <input class="form-check-input" type="checkbox" id="available" name="available"
                     th:checked="${available}">
              <label class="form-check-label" for="available">Only available</label>
            </div>

            <div>
              <label class="form-label">Author contains</label>
              <input class="form-control" type="text" name="author" th:value="${author}">
            </div>

            <div>
              <label class="form-label">Publication year</label>
              <div class="d-flex gap-2">
                <input class="form-control" type="number" name="yearFrom" th:value="${yearFrom}" placeholder="From" min="0" max="9999">
                <input class="form-control" type="number" name="yearTo" th:value="${yearTo}" placeholder="To" min="0" max="9999">
              </div>
            </div>

            <div>
              <label class="form-label">Sort by</label>
              <select class="form-select" name="sort" th:value="${sort}">
                <option value="relevance">Relevance</option>
                <option value="newest">Newest first</option>
                <option value="title">Title Aâ€“Z</option>
              </select>
            </div>

            <button class="btn btn-outline-primary w-100" type="submit">Apply filters</button>
            <a class="btn btn-link w-100" th:href="@{/}">Reset all</a>
          </form>
        </div>
      </div>
    </aside>

    <!-- RIGHT: Results -->
    <main class="col-12 col-md-9">
      <!-- Active filter chips -->
      <div class="mb-3" th:if="${hasQuery}">
        <span class="badge text-bg-light me-1" th:if="${q}">q: <span th:text="${q}"></span></span>
        <span class="badge text-bg-light me-1" th:if="${author}">author: <span th:text="${author}"></span></span>
        <span class="badge text-bg-light me-1" th:if="${available}">available</span>
        <span class="badge text-bg-light me-1" th:if="${yearFrom}">from <span th:text="${yearFrom}"></span></span>
        <span class="badge text-bg-light me-1" th:if="${yearTo}">to <span th:text="${yearTo}"></span></span>
      </div>

      <!-- No results / initial state messages -->
      <div th:if="${hasQuery && #lists.isEmpty(books)}" class="alert alert-light">
        No results for your filters. Try broadening your search.
      </div>
      <div th:if="${hasQuery == false}" class="alert alert-info">
        Start by searching or picking a filter on the left.
      </div>

      <!-- Results header -->
      <div class="d-flex justify-content-between align-items-center mb-2" th:if="${!#lists.isEmpty(books)}">
        <div>
          <span th:text="${count}">0</span>
          <span>result(s)</span>
          <span th:if="${q}">&nbsp;for "<span th:text="${q}"></span>"</span>
        </div>
      </div>

      <!-- Results table (keeps your existing columns/actions) -->
      <div class="card" th:if="${!#lists.isEmpty(books)}">
        <div class="table-responsive">
          <table class="table table-sm mb-0">
            <thead class="table-light">
              <tr>
                <th>ISBN</th>
                <th>Title</th>
                <th>Authors</th>
                <th>Description</th>
                <th class="text-end">Action</th>
              </tr>
            </thead>
            <tbody>
              <tr th:each="b : ${books}">
                <td th:text="${b.isbn}">ISBN</td>
                <td th:text="${b.title}">Title</td>
                <td th:text="${b.authors}">Authors</td>
                <td th:text="${b.description}">Description</td>
                <td class="text-end">
                  <form th:action="@{'/books/' + ${b.id} + '/borrow'}" method="post" class="d-inline">
                    <input type="hidden" th:name="${_csrf.parameterName}" th:value="${_csrf.token}"/>
                    <button class="btn btn-success btn-sm" th:disabled="${!b.available}">Borrow</button>
                  </form>
                </td>
              </tr>
            </tbody>
          </table>
        </div>
      </div>

      <!-- Pager -->
      <nav class="mt-3" th:if="${page != null and page.totalPages > 1}">
        <ul class="pagination">
          <li class="page-item" th:classappend="${page.first} ? 'disabled'">
            <a class="page-link"
               th:href="@{/(
                 q=${q}, author=${author}, available=${available},
                 yearFrom=${yearFrom}, yearTo=${yearTo},
                 sort=${sort}, page=${page.number-1}, size=${page.size}
               )}">Prev</a>
          </li>
          <li class="page-item disabled">
            <span class="page-link" th:text="${page.number + 1} + ' / ' + ${page.totalPages}">1 / 1</span>
          </li>
          <li class="page-item" th:classappend="${page.last} ? 'disabled'">
            <a class="page-link"
               th:href="@{/(
                 q=${q}, author=${author}, available=${available},
                 yearFrom=${yearFrom}, yearTo=${yearTo},
                 sort=${sort}, page=${page.number+1}, size=${page.size}
               )}">Next</a>
          </li>
        </ul>
      </nav>
    </main>
  </div>
</body>
</html>
